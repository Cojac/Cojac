% ==============
% COJAC analysis
% ==============

\chapter{COJAC}

\section{Bytecode JAVA}

La \textbf{machine virtuelle JAVA} (\textbf{Java Virtual Machine} ou \textbf{JVM}) utilise un seul langage: le Bytecode JAVA. Bien qu'il soit possible de programmer en JAVA, en Kotlin ou encore en C pour nommer quelques exemples, la JVM n'utilise que du Bytecode.

Le nom de Bytecode provient du fait que chaque code d'opération fait exactement 1 byte. Ceci limite fortement le nombre de codes d'opération disponibles à 256. Certains codes d'opérations peuvent être suivis de paramètres précisant l'opération à effectuer. Voici deux exemples de Bytecode dont leur fonctionnement sera illustré plus loin. La première opération prend un byte en paramètre alors que la deuxième opération n'en prend pas.
\begin{minted}{text}
bipush 5
iadd
\end{minted}

Contrairement aux processeurs habituels, la JVM utilise une pile au lieu de registres. Certaines opérations permettent de charger des informations sur la pile ou d'y retirer un élément pour le stocker dans une variable. Toutes les autres opérations prennent comme entrée les valeurs sur la pile et ajoute le résultat sur cette même pile.

Voici un exemple de Bytecode qui permet de mettre deux integers sur la pile et de les additionner:
\begin{minted}{text}
bipush 5
bipush 7
iadd
\end{minted}

L'exécution de ce Bytecode est illustrée sur la figure \ref{fig:cojac_bytecode_stack_addition}. Pour cet exemple, la pile est vide avant d'exécuter ces commandes. L'exécution se déroule en plusieurs étapes:
\begin{enumerate}
    \item Le nombre 5 est ajouté sur la pile.
    \item Le nombre 7 est ajouté sur la pile.
    \item L'addition consomme les deux nombres et ajoute le résultat sur la pile.
\end{enumerate}

\begin{minipage}{\linewidth}% to keep image and caption on one page
\makebox[\linewidth]{%        to center the image
    \includegraphics[width=.7\linewidth]{cojac/stack_addition_example.png}
}
\captionof{figure}{Addition de deux nombres en Bytecode JAVA}
\label{fig:cojac_bytecode_stack_addition}
\end{minipage}

\section{Agent JAVA}

Un agent Java est un programme Java spécial conçu pour modifier le comportement d'un autre programme sans en modifier le coude source. Comme montré dans la figure \ref{fig:cojac_classloading}, l'agent JAVA intercepte les fichiers .class qui contiennent du Bytecode et peut y apporter des modifications.

\begin{minipage}{\linewidth}
    \centering
    \includegraphics[width=.7\linewidth]{cojac/principle.png}
    \captionof{figure}{Chargement d'une classe}
    \label{fig:cojac_classloading}
\end{minipage}

Cette fonctionnalité est particulièrement utile pour des programmes pouvant fonctionner avec beaucoup d'autres applications. Ils peuvent offrir, par exemple, du monitoring, du profilage, etc.

Il existe deux types d'agents qui seront appelés, dans ce document, agent statique et agent dynamique.

\subsection{Agent statique}

Un agent statique est un agent qui est spécifié au démarrage du programme. Ainsi, lors du démarrage de l'application, l'agent et la JVM intéragissent ensemble conformément à la figure \ref{fig:cojac_static_agent}. Cette intéraction se déroule en plusieurs étapes:

\begin{enumerate}
    \item La JVM appelle l'agent en lui donnant le paramètre spécifié (un string) lors du démarrage de l'application. La méthode appelée s'appelle \textit{premain} parce qu'elle est exécutée avant le \textit{main} de l'application cible.
    \item Dans cette méthode \textit{premain}, l'agent doit créer un \textit{ClassFileTransformer}. Cet objet sera utilisé plus tard pour modifié les classes. Cet objet est ensuite donné à la JVM grâce à la méthode \textit{Instrumentation.addTransformer}.
    \item Ensuite à chaque fois que la JVM veut charger une nouvelle classe, le \textit{ClassLoader} lira le fichier \textit{.class} correspondant.
    \item Le \textit{ClassLoader} enverra ensuite le tableau de bytes qu'il vient de lire au \textit{ClassFileTransformer} qui pourra y apporter les modifications désirées.
    \item Une fois que le \textit{ClassFileTransformer} a modifié la classe, il la retournera la classe à la JVM.
\end{enumerate}

\begin{minipage}{\linewidth}% to keep image and caption on one page
\makebox[\linewidth]{%        to center the image
    \includegraphics[width=.7\linewidth]{cojac/static_agent.png}
}
\captionof{figure}{Fonctionnement d'un agent statique}
\label{fig:cojac_static_agent}
\end{minipage}

\subsection{Agent dynamique}

Un agent dynamique est un agent qui est ajouté après le démarrage de l'application cible. Ceci rend la modification du programme plus complexe et nécessite une autre application pour insérer l'agent. L'ajout de l'agent se déroule en plusieurs étapes comme montré sur la figure \ref{fig:cojac_dynamic_agent}:

\begin{enumerate}
    \item Une application pour ajouter l'agent doit être créé. Cette application doit s'attacher à la JVM du processus dans lequel l'agent doit être inséré. Cette opération peut se faire que si l'application cible et l'application source sont sur des processus possédés par le même utilisateur pour des raisons de sécurité.
    \item L'application source charge ensuite l'agent dans l'application cible.
    \item Contrairement à l'agent statique, la JVM appelle une autre méthode nommée \textit{agentmain}.
    \item L'agent enregistre ensuite son \textit{ClassFileTransformer}.
    \item Cette étape est facultative. Cependant, comme l'application cible a démarrée avant l'agent, elle a déjà chargée certaines classes. La méthode \textit{Instrumentation.\hspace{0pt}retransformClasses} permet de transformer les classes déjà chargées. Cependant, il y a quelques restrictions. Pour chaque classe à retransformer, les étapes 6 à 9 seront à nouveau exécutées.
    \item Ensuite à chaque fois que la JVM veut charger une nouvelle classe, le \textit{ClassLoader} lira le fichier \textit{.class} correspondant.
    \item Le \textit{ClassLoader} enverra ensuite le tableau de bytes qu'il vient de lire au \textit{ClassFileTransformer} qui pourra y apporter les modifications désirées.
    \item Une fois que le \textit{ClassFileTransformer} a modifié la classe, il la retournera la classe à la JVM.
\end{enumerate}

\begin{minipage}{\linewidth}
\makebox[\linewidth]{
    \includegraphics[width=.7\linewidth]{cojac/dynamic_agent.png}
}
\captionof{figure}{Fonctionnement d'un agent dynamique}
\label{fig:cojac_dynamic_agent}
\end{minipage}

\subsection{Synthèse}

Un agent permet de modifier le comportement de l'application cible sans en modifier le code source. Cette fonctionnalité permet de faire du profilage, de surveiller des applications ou de modifier le comportement d'une libraire propriétaire.

Les agents statiques et dynamiques ont des objectifs différents. Voici leurs avantages et inconvénients respectifs.

Les agents statiques possèdent les caractéristiques suivantes :
\begin{itemize}
    \item Le changement de l'agent statique nécessite de redémarrer l'application cible.
\end{itemize}

Les agents dynamiques possèdent les caractéristiques suivantes :
\begin{itemize}
    \item La retransformation de classes a d'importantes limites jusqu'en Java 14.
    \item L'agent peut être ajouté après que l'application ait démarré. Cette fonctionnalité permet, par exemple, de pouvoir obtenir des informations sur une application ayant un bug rare, inconnu ou qui se produit après un certain temps d'activité.
\end{itemize}

\section{Intégration}

COJAC \cite{COJAC} propose deux manières d'intégrer une nouvelle fonctionnalité:
\begin{itemize}
    \item \textbf{Behaviour}: les opérations sur les floats et les doubles sont simplement remplacées par un appel de méthode. Ainsi, il est possible de changer le comportement de ceux-ci. Dans ce projet, il serait possible de mettre la partie réelle et la partie imaginaire dans un double et de modifier les opérations qui les utilisent.
    \item \textbf{Wrapper}: les floats et les doubles peuvent être remplacés par un objet (wrapper). Ce qui permet d'ajouter plus d'éléments dans le wrapper.
\end{itemize}

Le Behaviour a les caractéristiques suivantes:
\begin{itemize}
    \item Le stockage est limité en taille (8 octets pour un double).
    \item Moins de modifications sont nécessaires. Toutes les opérations sur les doubles et les appels de la méthodes de la librairie standard doivent être modifiés. Il est également possible de convertir les floats en doubles. A ce moment, il y a beaucoup plus de modifications.
\end{itemize}

Le Wrapper a les caractéristiques suivantes:
\begin{itemize}
    \item Le stockage est illimité.
    \item Beaucoup de modifications doivent être effectuées. Toutes les constantes, signatures de méthode, opérations, etc. doivent être adaptées parce qu'un type de base et un objet sont radicalement différents.
\end{itemize}

\section{Maven}

COJAC \cite{COJAC} utilise Maven \cite{maven} pour créer le JAR. Maven \cite{maven} est un outil d'automatisation pour gérer les dépendances et produire une application. Cet outil peut télécharger les dépendances, compiler le projet, exécuter les tests unitaires et d'intégration et déployer le projet. Maven et Gradle sont les deux outils les plus souvent utilisés pour gérer les projets Java. Toute la configuration se trouve dans le fichier \textit{pom.xml}.

\subsection{Debug}

Lorsqu'il y a un problème avec Maven, il y a plusieurs paramètres qui permettent d'obtenir plus d'informations. Cette section montre comment configurer ces paramètres sous IntelliJ et donne l'argument équivalent pour appeler Maven en ligne de commande.

\begin{minipage2}
\subtitle{Ouvrir la fenêtre Maven}

Toutes les configurations effectuées ci-dessous seront effectuées depuis la fenêtre Maven dans IntelliJ. Le bouton pour l'ouvrir se situe sous \textbf{View} $\rightarrow$ \textbf{Tool Windows} $\rightarrow$ \textbf{Maven} comme montré sur la figure \ref{fig:maven_open_window}.
\end{minipage2}

\begin{minipage}{\linewidth}% to keep image and caption on one page
\makebox[\linewidth]{%        to center the image
    \includegraphics[width=.7\linewidth]{maven/open_maven_window.png}
}
\captionof{figure}{Bouton d'ouverture de la fenêtre Maven}
\label{fig:maven_open_window}
\end{minipage}

\subtitle{}

\subtitle{Fenêtre Maven}

La fenêtre Maven montre le contenu du projet avec les étapes du cycle de vie de la production de l'application comme le montre la figure \ref{fig:maven_window}. Le bouton encadré sur l'image permet d'ouvrir les paramètres de Maven qui seront utilisés plus tard. On peut également voir les plugins et les dépendances. Cette fenêtre permet aussi d'exécuter les étapes pour produire l'application. L'étape \textit{package} est suffisante pour générer le JAR.

\begin{minipage}{\linewidth}
\makebox[\linewidth]{
    \includegraphics[width=.5\linewidth]{maven/maven_window_annotated.png}
}
\captionof{figure}{Fenêtre Maven}
\label{fig:maven_window}
\end{minipage}

Une option peut être ajoutée pour afficher les messages de debug. Cette option est plus souvent utilisée lors du développement de Maven ou d'un plugin Maven. Cependant, elle peut également être utile pour trouver la source d'un problème difficile. \todo{image}. L'option en ligne de commande équivalente se nomme \textit{-{}-debug}.